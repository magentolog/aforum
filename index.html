<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Floor Plan Editor</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.4.6/fabric.min.js"></script>

  <style>
    .floor-plan-container {
      padding: 5px;
    }

    #bg-img {
      opacity: 0.4;
    }

    #canvas {
      border: 1px solid black;
      opacity: 0.9;
    }

    .canvas-container {
      float: left;
      position: relative;
    }

    .absolute {
      position: absolute;
      top: 0;
      left: 0;
    }

    .tools-container {
      float: left;
      position: sticky;
      top: 0;
    }

    .controlls {
      margin: 0 20px;
    }

    .controlls div {
      margin: 10px 5px;
    }

    .footer {
      clear: both;
    }

    #data {
      width: 100%;
      height: 200px;
    }

    #btn-demo {
      animation-duration: 20s;
      animation-iteration-count: infinite;
      animation-name: blinking;
    }

    @keyframes blinking {
      0% {
        background-color: lightgray;
      }

      50% {
        background-color: red;
      }

      100% {
        background-color: lightgray;
      }
    }
  </style>

  <script>
    const CLASS = 'myType';
    const CLASS_ROOM = 'Room';
    const CLASS_TABLE = 'Table';
    const CLASS_ROOM_ID = 'RoomId';
    const CLASS_ROOM_NAME = 'RoomName';
    const INDENT_X = 30;
    const INDENT_Y = 30;


    var floorPlanLuenen =
    {
      "height": 584,
      "width": 1364,
      "rooms": [{ "left": 0, "top": 8, "width": 236, "height": 180 }, { "left": 235, "top": 8, "width": 344, "height": 180 }, { "left": 579, "top": 8, "width": 257, "height": 180 }, { "left": 0, "top": 186, "width": 136, "height": 91 }, { "left": 693, "top": 187, "width": 145, "height": 134 }, { "left": 838, "top": 187, "width": 111, "height": 134 }, { "left": 948, "top": 164, "width": 170, "height": 157 }, { "left": 1119, "top": 164, "width": 240, "height": 157 }, { "left": 0, "top": 277, "width": 465, "height": 88 }, { "left": 0, "top": 367, "width": 465, "height": 217 }, { "left": 465, "top": 367, "width": 370, "height": 217 }, { "left": 835, "top": 367, "width": 169, "height": 158 }, { "left": 1005, "top": 367, "width": 169, "height": 180 }, { "left": 1176, "top": 367, "width": 185, "height": 180 }],
      "rnames": [{ "left": 143, "top": 122, "text": "Darth Vader" }, { "left": 26, "top": 208, "text": "Luke Skywalker" }, { "left": 415, "top": 70, "text": "R2-D2" }, { "left": 668, "top": 81, "text": "Glaskasten" }, { "left": 739, "top": 240, "text": "Küche" }, { "left": 872, "top": 239, "text": "WC's" }, { "left": 960, "top": 304, "text": "Chewobacca" }, { "left": 1154, "top": 303, "text": "C-3PO" }, { "left": 354, "top": 295, "text": "Obi-Wan Kenobi" }, { "left": 367, "top": 446, "text": "Boba Fett" }, { "left": 894, "top": 400, "text": "Princess Leia" }, { "left": 1017, "top": 395, "text": "Han Solo" }, { "left": 1199, "top": 424, "text": "Master Yoda" }],
      "rids": [{ "left": 182, "top": 164, "text": "L004" }, { "left": 350, "top": 164, "text": "L005" }, { "left": 667, "top": 162, "text": "L006" }, { "left": 89, "top": 257, "text": "L003" }, { "left": 415, "top": 340, "text": "L002" }, { "left": 417, "top": 395, "text": "L001" }, { "left": 960, "top": 374, "text": "L011" }, { "left": 1015, "top": 374, "text": "L010" }, { "left": 1189, "top": 376, "text": "L009" }, { "left": 1237, "top": 302, "text": "L008" }, { "left": 1075, "top": 302, "text": "L007" }],
      "tables": [{ "left": 78, "top": 30, "width": 30, "height": 67 }, { "left": 108, "top": 30, "width": 30, "height": 67 }, { "left": 238, "top": 73, "width": 30, "height": 67 }, { "left": 352, "top": 30, "width": 30, "height": 67 }, { "left": 522, "top": 9, "width": 30, "height": 67 }, { "left": 549, "top": 78, "width": 30, "height": 67 }, { "left": 580, "top": 78, "width": 30, "height": 67 }, { "left": 805, "top": 29, "width": 30, "height": 67 }, { "left": 805, "top": 99, "width": 30, "height": 67 }, { "left": 1003, "top": 166, "width": 30, "height": 67 }, { "left": 1035, "top": 166, "width": 30, "height": 67 }, { "left": 1003, "top": 234, "width": 30, "height": 67 }, { "left": 1035, "top": 234, "width": 30, "height": 67 }, { "left": 1203, "top": 212, "width": 30, "height": 67 }, { "left": 1233, "top": 212, "width": 30, "height": 67 }, { "left": 1262, "top": 369, "width": 30, "height": 67 }, { "left": 1263, "top": 479, "width": 30, "height": 67 }, { "left": 1231, "top": 479, "width": 30, "height": 67 }, { "left": 1059, "top": 414, "width": 30, "height": 67 }, { "left": 1090, "top": 414, "width": 30, "height": 67 }, { "left": 949, "top": 457, "width": 30, "height": 67 }, { "left": 918, "top": 457, "width": 30, "height": 67 }, { "left": 267, "top": 30, "width": 84, "height": 26 }, { "left": 238, "top": 142, "width": 84, "height": 26 }, { "left": 496, "top": 147, "width": 84, "height": 26 }, { "left": 411, "top": 147, "width": 84, "height": 26 }, { "left": 609, "top": 8, "width": 84, "height": 26 }, { "left": 693, "top": 8, "width": 84, "height": 26 }, { "left": 1149, "top": 184, "width": 84, "height": 26 }, { "left": 1234, "top": 184, "width": 84, "height": 26 }, { "left": 51, "top": 295, "width": 84, "height": 26 }, { "left": 51, "top": 322, "width": 84, "height": 26 }, { "left": 136, "top": 295, "width": 102, "height": 26 }, { "left": 136, "top": 322, "width": 102, "height": 26 }, { "left": 238, "top": 295, "width": 84, "height": 26 }, { "left": 238, "top": 322, "width": 84, "height": 26 }, { "left": 1059, "top": 388, "width": 62, "height": 26 }, { "left": 106, "top": 388, "width": 101, "height": 26 }, { "left": 208, "top": 388, "width": 88, "height": 26 }, { "left": 106, "top": 414, "width": 101, "height": 26 }, { "left": 208, "top": 414, "width": 88, "height": 26 }, { "left": 209, "top": 498, "width": 88, "height": 26 }, { "left": 209, "top": 524, "width": 88, "height": 26 }, { "left": 108, "top": 498, "width": 101, "height": 26 }, { "left": 108, "top": 524, "width": 101, "height": 26 }]
    }

    var floorPlanDortmund =
    {
      "height": 1000,
      "width": 754,
      "rooms": [{ "left": 0, "top": 0, "width": 226, "height": 202 }, { "left": 527, "top": 0, "width": 226, "height": 203 }, { "left": 527, "top": 203, "width": 226, "height": 180 }, { "left": 527, "top": 382, "width": 226, "height": 227 }, { "left": 0, "top": 203, "width": 226, "height": 275 }, { "left": 227, "top": 0, "width": 151, "height": 203 }, { "left": 377, "top": 0, "width": 150, "height": 203 }, { "left": 0, "top": 616, "width": 225, "height": 185 }, { "left": 0, "top": 800, "width": 225, "height": 198 }, { "left": 224, "top": 801, "width": 303, "height": 198 }, { "left": 527, "top": 610, "width": 226, "height": 189 }, { "left": 527, "top": 800, "width": 226, "height": 199 }],
      "rnames": [{ "left": 148, "top": 313, "text": "Ganymed" }, { "left": 91, "top": 178, "text": "Titan" }, { "left": 268, "top": 179, "text": "Ceres" }, { "left": 431, "top": 179, "text": "Callisto" }, { "left": 596, "top": 179, "text": "Io" }, { "left": 540, "top": 259, "text": "Hyperion" }, { "left": 541, "top": 437, "text": "Erde (Besprechungsraum)" }, { "left": 533, "top": 692, "text": "Luna" }, { "left": 612, "top": 806, "text": "Fitnessraum" }, { "left": 370, "top": 808, "text": "Mars" }, { "left": 56, "top": 808, "text": "Europa" }, { "left": 172, "top": 655, "text": "Pluto" }],
      "rids": [{ "left": 174, "top": 284, "text": "D201" }, { "left": 168, "top": 180, "text": "D202" }, { "left": 326, "top": 180, "text": "D203" }, { "left": 383, "top": 179, "text": "D204" }, { "left": 546, "top": 180, "text": "D205" }, { "left": 540, "top": 288, "text": "D206" }, { "left": 540, "top": 437, "text": "D207" }, { "left": 533, "top": 719, "text": "D208" }, { "left": 562, "top": 807, "text": "D209" }, { "left": 323, "top": 808, "text": "D210" }, { "left": 121, "top": 809, "text": "D211" }, { "left": 174, "top": 631, "text": "D212" }],
      "tables": [{ "left": 14, "top": 82, "width": 93, "height": 30 }, { "left": 14, "top": 113, "width": 93, "height": 30 }, { "left": 107, "top": 82, "width": 46, "height": 61 }, { "left": 105, "top": 241, "width": 46, "height": 61 }, { "left": 105, "top": 379, "width": 46, "height": 61 }, { "left": 251, "top": 91, "width": 69, "height": 37 }, { "left": 424, "top": 90, "width": 69, "height": 37 }, { "left": 250, "top": 876, "width": 68, "height": 37 }, { "left": 426, "top": 875, "width": 70, "height": 37 }, { "left": 12, "top": 241, "width": 93, "height": 30 }, { "left": 12, "top": 272, "width": 93, "height": 30 }, { "left": 12, "top": 379, "width": 93, "height": 30 }, { "left": 12, "top": 410, "width": 93, "height": 30 }, { "left": 644, "top": 79, "width": 93, "height": 30 }, { "left": 644, "top": 110, "width": 93, "height": 30 }, { "left": 642, "top": 293, "width": 93, "height": 30 }, { "left": 642, "top": 323, "width": 93, "height": 31 }, { "left": 643, "top": 223, "width": 93, "height": 30 }, { "left": 596, "top": 293, "width": 46, "height": 61 }, { "left": 14, "top": 643, "width": 93, "height": 30 }, { "left": 14, "top": 674, "width": 93, "height": 30 }, { "left": 107, "top": 643, "width": 46, "height": 61 }, { "left": 597, "top": 719, "width": 46, "height": 61 }, { "left": 643, "top": 750, "width": 93, "height": 30 }, { "left": 643, "top": 719, "width": 93, "height": 30 }, { "left": 650, "top": 613, "width": 87, "height": 30 }, { "left": 562, "top": 613, "width": 87, "height": 30 }, { "left": 13, "top": 768, "width": 93, "height": 30 }, { "left": 251, "top": 11, "width": 34, "height": 80 }, { "left": 286, "top": 11, "width": 34, "height": 80 }, { "left": 424, "top": 11, "width": 34, "height": 80 }, { "left": 459, "top": 11, "width": 34, "height": 80 }, { "left": 250, "top": 913, "width": 34, "height": 80 }, { "left": 284, "top": 913, "width": 34, "height": 80 }, { "left": 462, "top": 912, "width": 34, "height": 80 }, { "left": 427, "top": 912, "width": 34, "height": 80 }, { "left": 642, "top": 864, "width": 93, "height": 30 }, { "left": 642, "top": 895, "width": 93, "height": 30 }, { "left": 596, "top": 864, "width": 46, "height": 61 }]
    };

    var floorPlanNew = {
      "height": 1000,
      "width": 754,
      "rooms": [],
      "rnames": [],
      "rids": [],
      "tables": []
    };

    var floorPlanMocks = [floorPlanDortmund, floorPlanLuenen, floorPlanNew];
    var floorPlanImgs = ["img/PlanDortmund.png", "img/PlanLuenen.jpg", "#"];

    var roomTemplate = {
      hasRotatingPoint: false,
      left: 100,
      top: 100,
      stroke: "black",
      strokeWidth: 2,
      fill: "rgba(0,0,0,0)",
      width: 100,
      height: 100
    };

    var tableTemplate = {
      hasRotatingPoint: false,
      //left: 100,
      //top: 100,
      angle: 0,
      stroke: "black",
      strokeWidth: 1,
      fill: "green",
      width: 80,
      height: 20
    };

    var roomNameTemplate = {
      left: 100,
      top: 100,
      //fontFamily: 'Comic Sans',
      fontFamily: 'Arial',
      shadow: 'rgba(0,0,0,0.3) 4px 4px 4px',
      fill: "blue",
      fontSize: 16,
      //lockScalingX: true,
      lockScalingY: true,
      //lockRotation: true
      textAlign: 'center'
    };

    var roomIdTemplate = {
      left: 110,
      top: 110,
      //fontFamily: 'Comic Sans',
      fontFamily: 'Arial',
      fill: "black",
      fontSize: 16,
      //lockScalingX: true,
      lockScalingY: true,
      //lockRotation: true
      textAlign: 'center'
    };

    var tableTextTemplate = {
      fontSize: 16,
      originX: 'center',
      originY: 'center'
    }

    $(document).ready(function () {
      var canvas = new fabric.Canvas("canvas");
      initCanvas(canvas);
      var reservationDialog = new ReservationDialog();
      var floorEditor = new FloorEditor(canvas);
      var demo = new FloorPlanDemo(canvas, reservationDialog);
    });

    function initCanvas(canvas) {
      canvas.forEachObject = function (className, callbackfn) {
        for (var i = 0, n = canvas.size(); i < n; i++) {
          var item = canvas.item(i);
          if (item.get(CLASS) == className) {
            callbackfn(item);
          }
        }
      }
    }

    function ReservationDialog() {
      var _this = this;
      var dialog = null;
      var form = null;
      var dateFormat = "mm/dd/yy";
      var from = null;
      var to = null;
      var callbackfn = null;
      init();

      function addReservation() {
        var result = serializeFormToJSON();
        if (typeof callbackfn === "function") {
          callbackfn(result);
        }
      }

      function serializeFormToJSON() {
        var fields = form.serializeArray();
        var result = {};
        jQuery.each(fields, function (i, field) {
          result[field.name] = field.value;
        });
        return result;
      }

      this.show = function (data, aCallbackFn) {
        for (x in data) {
          form.find("#" + x).val(data[x]);
        }
        callbackfn = aCallbackFn;
        dialog.dialog("open");
      }

      
      function getDate(element) {
        var date;
        try {
          date = $.datepicker.parseDate(dateFormat, element.value);
        } catch (error) {
          date = null;
        }

        return date;
      }


      function init() {
        from = $("#from")
          .datepicker({
            defaultDate: "-1d",
            changeMonth: true,
            numberOfMonths: 2
          })
          .on("change", function () {
            to.datepicker("option", "minDate", getDate(this));
          });
          to = $("#to").datepicker({
            defaultDate: "+1w",
            changeMonth: true,
            numberOfMonths: 2
          })
            .on("change", function () {
              from.datepicker("option", "maxDate", getDate(this));
            });


        dialog = $("#dialog-form").dialog({
          autoOpen: false,
          height: 400,
          width: 350,
          modal: true,
          buttons: {
            "Save": function () {
              addReservation();
              dialog.dialog("close");
            },
            "Delete": function () {
              $("#name").val("");
              addReservation();
              dialog.dialog("close");
            },
            Cancel: function () {
              dialog.dialog("close");
            }
          },
          close: function () {
            form[0].reset();
            //allFields.removeClass("ui-state-error");
          }
        });

        form = dialog.find("form").on("submit", function (event) {
          event.preventDefault();
          addReservation();
        });


      }
    }

    function FloorPlanDemo(canvas, reservationDialog) {
      var _this = this;
      var users = ['Patrick', 'Lasse', 'Thilo', 'Robin', 'Björn', 'Svenja', 'Julia', 'John', 'Praktikant', 'Andre', 'Timm', 'Alex', 'Jane', 'Jimm', 'Praktikant'];

      init();
      function init() {
        $("#btn-demo").click(function () {
          run();
        });
      }

      function run() {
        blockAll();
        showNextDay();
      }

      function rnd(max) {
        return Math.floor(Math.random() * max); // return random integer value 0..max
      }

      function getRandomUser() {
        var n = users.length;
        return users[rnd(n)];
      }

      function getRandomDate() {
        return new Date();
      }

      function blockAll() {
        for (var i = 0, n = canvas.size(); i < n; i++) {
          var item = canvas.item(i);
          item.hasControls = false;
          item.lockMovementX = true;
          item.lockMovementY = true;
          if (item.get(CLASS) === CLASS_ROOM) {
            item.selectable = false;
          }
        }
      }

      function showNextDay() {
        canvas.forEachObject(CLASS_TABLE, function (table) {
          var username = getRandomUser();
          if (rnd(10) < 2) {
            table.item(0).set("fill", "green");
            table.item(1).set("text", "click(2) me!");
          } else {
            table.item(0).set("fill", "gray");
            table.item(1).set("text", getRandomUser());
          }
          table.off('mousedblclick');
          table.on('mousedblclick', function (e) {
            var tableObj = this;
            var oldName = tableObj.item(1).get('text');
            if (oldName === 'click(2) me!') oldName = '';
            // var newName = prompt('Enter new user name:', oldName);
            var data = (oldName === "")? {from:"", to:"", name:oldName} : {from:"01.03.2019", to:"01.05.2019", name:oldName}; 
            reservationDialog.show(data, function (data) {              
              var newName = data.name;
              if (newName !== null) {
                tableObj.item(1).set('text', newName);
                table.item(0).set("fill", (newName.length) ? "gray" : "green");
                canvas.renderAll();
              }
            });
          });
        });
        canvas.renderAll();
      }
    }

    function FloorEditor(canvas) {
      var _this = this;
      var floorPlan = {};

      init();
      function init() {
        setFloorPlan(floorPlanMocks[0]);
        showData();
        initToolBar();
      }

      function initToolBar() {
        $("#btn-add-room").click(function () {
          var data = getLastObjData(CLASS_ROOM, INDENT_X, INDENT_Y);
          addRoom(data);
        });

        $("#btn-add-table").click(function () {
          var data = getLastObjData(CLASS_TABLE, INDENT_X, INDENT_Y);
          addTable(data);
        });

        $("#btn-add-room-name").click(function () {
          var text = ($("#ed-room-name").val()).trim();
          if (text) {
            var data = getLastObjData(CLASS_ROOM_NAME, INDENT_X, INDENT_Y);
            addRoomName(text, data);
          }
          $("#ed-room-name").val("");
        });

        $("#btn-add-room-id").click(function () {
          var text = ($("#ed-room-id").val()).trim();
          if (text) {
            var data = getLastObjData(CLASS_ROOM_ID, INDENT_X, INDENT_Y);
            addRoomId(text, data);
          }
          $("#ed-room-id").val("");
        });

        $("#btn-export-data").click(function () {
          showData();
        });

        $("#btn-import-data").click(function () {
          var text = $("#data").val();
          importData(text);
        });

        $(document).keydown(function (event) {
          if ((document.body === document.activeElement)
            && (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].indexOf(event.key) >= 0)) {
            moveSelectedObject(event.key);
            event.preventDefault();
            event.stopPropagation();
          }
        });

        canvas.on('mouse:wheel', function (opt) {
          var delta = opt.e.deltaY;
          var zoom = canvas.getZoom();
          zoom = zoom + delta / 2000;
          if (zoom > 2) zoom = 2;
          if (zoom < 0.2) zoom = 0.2;
          setZoom(zoom);
          opt.e.preventDefault();
          opt.e.stopPropagation();
        });

        $("#cb-show-img").click(function () {
          if (this.checked) {
            $("#bg-img").show();
          } else {
            $("#bg-img").hide();
          }
        });

        $("#btn-delete").click(function () {
          var obj = canvas.getActiveObject();
          if (obj) {
            canvas.remove(obj);
            var n = canvas.size() - 1;
            if (n >= 0) {
              canvas.setActiveObject(canvas.item(n));
            }
          }
        });

        $(".rb-select-location input").change(function () {
          var value = $(this).val();
          setFloorPlan(floorPlanMocks[value]);
          showData();
          $("#bg-img").attr("src", floorPlanImgs[value]);
        });
      }

      function moveSelectedObject(key) {
        var obj = canvas.getActiveObject();
        if (obj) {
          switch (key) {
            case "ArrowLeft": obj.left = obj.left - 1;
              break;
            case "ArrowRight": obj.left = obj.left + 1;
              break;
            case "ArrowUp": obj.top = obj.top - 1;
              break
            case "ArrowDown": obj.top = obj.top + 1;
              break
          }
          canvas.requestRenderAll();
        }
      }

      function setZoom(zoom) {
        var width = Math.round(floorPlan.width * zoom);
        var height = Math.round(floorPlan.height * zoom);
        $("#bg-img").attr("width", width);
        $("#bg-img").attr("height", height);
        canvas.setWidth(width);
        canvas.setHeight(height);
        canvas.setZoom(zoom);
      }

      function setFloorPlan(aFloorPlan) {
        floorPlan = Object.assign({}, aFloorPlan);
        canvas.clear();
        setZoom(1);
        canvas.requestRenderAll();

        floorPlan.rooms.forEach(function (data) {
          addRoom(data);
        });

        floorPlan.tables.forEach(function (data) {
          addTable(data);
        });

        floorPlan.rnames.forEach(function (data) {
          addRoomName(data.text, data);
        });

        floorPlan.rids.forEach(function (data) {
          addRoomId(data.text, data);
        });

      }

      function showData() {
        var plan = getFloorPlanObj(canvas.getZoom());
        var text = floorPlanToString(plan);
        $("#data").val(text);
      }

      function importData(text) {
        var newPlan = JSON.parse(text);
        if (newPlan) {
          setFloorPlan(newPlan);
        }
      }

      function getFabricObjData(fabricObj, dx = 0, dy = 0, zoom = 1) {
        var result =
        {
          left: Math.round(fabricObj.left * zoom),
          top: Math.round(fabricObj.top * zoom),
          width: Math.round(fabricObj.width * fabricObj.scaleX * zoom),
          height: Math.round(fabricObj.height * fabricObj.scaleY * zoom),
        }
        if ([CLASS_ROOM_ID, CLASS_ROOM_NAME].indexOf(fabricObj.get(CLASS)) >= 0) {
          result.text = fabricObj.text;
          delete result.width;
          delete result.height;
        }
        if (typeof dx === "number") {
          result.left += dx;
        }
        if (typeof dy === "number") {
          result.top += dy;
        }
        return result;
      }

      function getFloorPlanObj(zoom = 1) {
        var newPlan = {
          height: Math.round(floorPlan.height * zoom),
          width: Math.round(floorPlan.width * zoom),
          rooms: [],
          tables: [],
          rnames: [],
          rids: []
        };

        canvas.forEachObject(CLASS_ROOM, function (obj) {
          newPlan.rooms.push(getFabricObjData(obj, 0, 0, zoom));
        });

        canvas.forEachObject(CLASS_TABLE, function (obj) {
          newPlan.tables.push(getFabricObjData(obj, 0, 0, zoom));
        });

        canvas.forEachObject(CLASS_ROOM_NAME, function (obj) {
          newPlan.rnames.push(getFabricObjData(obj, 0, 0, zoom));
        });

        canvas.forEachObject(CLASS_ROOM_ID, function (obj) {
          newPlan.rids.push(getFabricObjData(obj, 0, 0, zoom));
        });

        return newPlan;
      }

      function floorPlanToString(plan) {
        var result = '{\n';
        result += '"height":' + plan.height + ',\n';
        result += '"width":' + plan.width + ',\n';
        result += '"rooms":' + JSON.stringify(plan.rooms) + ',\n';
        result += '"rnames":' + JSON.stringify(plan.rnames) + ',\n';
        result += '"rids":' + JSON.stringify(plan.rids) + ',\n';
        result += '"tables":' + JSON.stringify(plan.tables) + '\n';
        result += '}\n';
        return result;
      }

      function getLastObjData(className, dx = 0, dy = 0) {
        var data = { top: 100, left: 100 };
        var obj = canvas.getActiveObject();
        if (obj && (obj.get(CLASS) === className)) {
          data = getFabricObjData(obj, dx, dy);
        }
        return data;
      }

      function addRoom(data) {
        var template = Object.assign({}, roomTemplate, data);
        var rect = new fabric.Rect(template);
        canvas.add(rect);
        canvas.setActiveObject(rect);
        rect.set(CLASS, CLASS_ROOM);
        return rect;
      }

      function addTable(data) {
        if (!data.hasOwnProperty('width')) {
          data.width = tableTemplate.width;
        }
        if (!data.hasOwnProperty('height')) {
          data.height = tableTemplate.height;
        }
        var rectTemplate = Object.assign({}, tableTemplate, { width: data.width, height: data.height, originX: 'center', originY: 'center' });
        var rect = new fabric.Rect(rectTemplate);
        var textTemplate = Object.assign({}, tableTextTemplate, { angle: (data.width > data.height) ? 0 : -90 });
        var text = new fabric.Text('', textTemplate);
        var group = new fabric.Group([rect, text], data);
        group.set(CLASS, CLASS_TABLE);
        canvas.add(group);
        canvas.setActiveObject(group);
        return group;
      }

      function addRoomName(text, data) {
        data.text = text;
        var template = Object.assign({}, roomNameTemplate, data);
        var rect = new fabric.Textbox(text, template);
        canvas.add(rect);
        canvas.setActiveObject(rect);
        rect.set(CLASS, CLASS_ROOM_NAME);
        return rect;
      }

      function addRoomId(text, data) {
        data.text = text;
        var template = Object.assign({}, roomIdTemplate, data);
        var rect = new fabric.Textbox(text, template);
        canvas.add(rect);
        canvas.setActiveObject(rect);
        rect.set(CLASS, CLASS_ROOM_ID);
        return rect;
      }

    }
  </script>
</head>

<body>
  <div class="floor-plan-container">
    <div class="canvas-container">
      <div class="absolute">
        <img id="bg-img" src="img/PlanDortmund.png" />
      </div>
      <div class="">
        <canvas id="canvas"></canvas>
      </div>
    </div>
    <div class="tools-container">
      <div class="controlls">
        <div><input id="cb-show-img" type="checkbox" checked="checked">Show Background image</div>
        <div class="rb-select-location">
          <label><input type="radio" value=0 name="location" checked="checked">Dortmund &nbsp;</label>
          <label><input type="radio" value=1 name="location">Lünen &nbsp;</label>
          <label><input type="radio" value=2 name="location">New</label>
        </div>
        <div><button id="btn-add-room">Add Room</button> <button id="btn-add-table">Add Table</button></div>
        <div><input id="ed-room-id" type="text" placeholder="201"> <button id="btn-add-room-id">Add Room.id</button>
        </div>
        <div><input id="ed-room-name" type="text" placeholder="Pluto"> <button id="btn-add-room-name">Add
            Room.name</button> </div>
        <div><button id="btn-delete">Delete Selected Object</button></div>
        <div>
          <textarea id="data"></textarea>
        </div>
        <div><button id="btn-export-data">Export to JSON</button> <button id="btn-import-data">Import from JSON</button>
        </div>
        <div><button id="btn-demo">Demo (Click me!)</button></div>
        <div></div>
      </div>
    </div>
    <div class="footer"></div>
  </div>
  <div class="dialog-forms">
    <div id="dialog-form" title="Reservation Form">
      <p class="validateTips"></p>
      <form>
        <fieldset>
          <label for="from">StartDate</label>
          <input type="text" id="from" name="from" >
          <br><br>
          <label for="to">&nbsp;&nbsp;EndDate</label>
          <input type="text" id="to" name="to" >
          <br><br>
          <label for="name">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name</label>
          <input type="text" name="name" id="name" value="" class="text ui-widget-content ui-corner-all" autofocus>

          <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
        </fieldset>
      </form>
    </div>
  </div>

</body>

</html>